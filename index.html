<!DOCTYPE html>
<html lang="id" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deteksi Lokasi Absen - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Scrollbar styling for attendance list */
    .scrollbar-thin::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(107, 114, 128, 0.5);
      border-radius: 4px;
    }

    /* IMPORTANT: Ensures display: none overrides other styles */
    .hidden {
      display: none !important;
    }

    /* Red urgent animation for "di luar lokasi" */
    @keyframes pulseRed {
      0%, 100% {
        background-color: #fee2e2;
        color: #b91c1c;
        box-shadow: 0 0 8px 2px rgba(185, 28, 28, 0.5);
      }
      50% {
        background-color: #fecaca;
        color: #991b1b;
        box-shadow: 0 0 12px 4px rgba(153, 27, 27, 0.7);
      }
    }
    .urgent-alert {
      animation: pulseRed 1.8s ease-in-out infinite;
      font-weight: 700;
      border-color: #b91c1c;
      border-width: 2px;
    }

    /* Table specific styling for better appearance */
    #attendanceList table {
      min-width: 768px; /* Ensure table has a minimum width to enable horizontal scroll on small screens */
    }

    #attendanceList th,
    #attendanceList td {
      padding: 12px 16px; /* Increased padding for better spacing */
      border-bottom: 1px solid #e5e7eb; /* Subtle bottom border for rows */
    }

    #attendanceList thead th {
      background-color: #f9fafb; /* Light background for header */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.875rem; /* Smaller font for headers */
      color: #4b5563; /* Darker gray for header text */
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Last child of header row should have no bottom border to avoid double border */
    #attendanceList thead tr:last-child th {
      border-bottom: none;
    }

    /* Remove bottom border for the last row of tbody */
    #attendanceTableBody tr:last-child td {
      border-bottom: none;
    }

    /* Add striped rows for better readability */
    #attendanceTableBody tr:nth-child(even) {
        background-color: #f9fafb; /* Lighter background for even rows */
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      flex-direction: column;
      gap: 16px; /* Space between spinner and text */
    }

    /* Spinner for loading overlay */
    .loading-spinner {
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid #3b82f6; /* Blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Initially hide the loading overlay */
    #firebaseLoadingOverlay {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

  <!-- Firebase Loading Overlay -->
  <div id="firebaseLoadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <p class="text-blue-600 font-semibold">Memuat data...</p>
  </div>

  <!-- Sticky Navbar -->
  <nav class="sticky top-0 bg-white shadow-sm z-20">
    <div class="max-w-5xl mx-auto flex items-center justify-between py-4 px-6">
      <div class="flex items-center space-x-2">
        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="font-extrabold text-xl tracking-tight select-none">AbsenLokasi</span>
      </div>
      <div class="space-x-4 flex items-center">
        <a href="#fitur" class="text-gray-600 hover:text-blue-600 font-medium transition hidden md:inline-block">Fitur</a>
        <a href="#absen" class="text-gray-600 hover:text-blue-600 font-medium transition hidden md:inline-block">Absen</a>
        <button id="adminLoginBtn" class="text-blue-600 font-semibold hover:underline focus:outline-none" type="button">Admin Login</button>
        <button id="adminLogoutBtn" class="text-red-600 font-semibold hover:underline focus:outline-none hidden" type="button" aria-label="Logout Admin">Logout Admin</button>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section id="heroSection" class="max-w-5xl mx-auto px-6 py-16 flex flex-col items-center text-center">
    <h1 class="text-4xl md:text-5xl font-extrabold mb-4 tracking-tight select-none">Deteksi Lokasi Absen</h1>
    <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-2xl select-none">
      Sistem absensi modern berbasis web yang memanfaatkan deteksi lokasi secara real-time. Pastikan kehadiran Anda di lokasi yang tepat, mudah dan aman!
    </p>
    <a href="#absen" class="inline-block">
      <button id="startBtn" class="px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
        Mulai Absen
      </button>
    </a>
  </section>

  <!-- Fitur Section -->
  <section id="fitur" class="max-w-5xl mx-auto px-6 py-10">
    <div class="grid md:grid-cols-3 gap-6">
      <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
        <svg class="w-10 h-10 text-blue-500 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 2C8 2 5 5 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-4-3-7-7-7z" />
          <circle cx="12" cy="9" r="2.5" />
        </svg>
        <h3 class="font-bold text-lg mb-2 select-none">Deteksi Lokasi Akurat</h3>
        <p class="text-gray-500 text-center select-none">Menggunakan GPS browser untuk memastikan kehadiran di lokasi yang ditentukan.</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
        <svg class="w-10 h-10 text-blue-500 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <rect x="3" y="7" width="18" height="13" rx="2" />
          <path d="M16 3v4" />
          <path d="M8 3v4" />
        </svg>
        <h3 class="font-bold text-lg mb-2 select-none">Mudah Digunakan</h3>
        <p class="text-gray-500 text-center select-none">Cukup satu klik untuk absen, tanpa instalasi aplikasi tambahan.</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
        <svg class="w-10 h-10 text-blue-500 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M5 13l4 4L19 7" />
        </svg>
        <h3 class="font-bold text-lg mb-2 select-none">Aman &amp; Privasi Terjaga</h3>
        <p class="text-gray-500 text-center select-none">Data lokasi hanya digunakan untuk keperluan absensi dan tidak disimpan.</p>
      </div>
    </div>
  </section>

  <!-- Absen Section (Employee attendance) -->
  <section id="absen" class="max-w-2xl mx-auto px-6 py-12">
    <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col items-center" id="absenSection">
      <h2 class="text-2xl font-bold mb-4 select-none">Formulir Absen Lokasi</h2>
      <p class="text-gray-500 mb-6 text-center select-none">Klik tombol di bawah untuk mendeteksi lokasi Anda secara otomatis.</p>
      <!-- Employee Identifier Input -->
      <label for="employeeName" class="self-start mb-2 font-medium text-gray-700 select-none">Nama Karyawan</label>
      <input type="text" id="employeeName" placeholder="Masukkan nama Anda" class="mb-6 w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent" autocomplete="off" />
      <button id="detectBtn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 disabled:bg-blue-300 mb-4" disabled>
        Deteksi Lokasi Sekarang
      </button>
      <div id="locationCard" class="w-full"></div>
    </div>
  </section>

  <!-- Admin Login Section (modal style) -->
  <div id="adminLoginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30 transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-8 transform transition-transform duration-300 scale-95 opacity-0" id="loginModalContent">
      <h3 id="loginModalTitle" class="text-3xl font-extrabold text-center text-gray-800 mb-8 select-none">Admin Access</h3>
      <form id="adminLoginForm" class="flex flex-col space-y-6" autocomplete="off">
        <div class="relative">
          <label for="adminUsername" class="absolute -top-3 left-3 text-sm font-medium text-gray-600 bg-white px-1">Username</label>
          <input id="adminUsername" name="adminUsername" type="text" autocomplete="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="Enter username" />
        </div>
        <div class="relative">
          <label for="adminPassword" class="absolute -top-3 left-3 text-sm font-medium text-gray-600 bg-white px-1">Password</label>
          <input id="adminPassword" name="adminPassword" type="password" autocomplete="current-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="Enter password" />
        </div>
        <button type="submit" class="mt-6 w-full py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transform hover:scale-105">
          Login Securely
        </button>
        <button type="button" id="closeLoginModalBtn" class="mt-4 text-center text-gray-500 hover:text-gray-900 transition-colors duration-200 focus:outline-none">Cancel</button>
        <p id="loginErrorMsg" class="text-red-600 text-sm mt-4 hidden select-none text-center font-medium" role="alert"></p>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard Section -->
  <section id="adminDashboard" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-6 hidden">
    <h2 class="text-3xl font-extrabold text-center mb-8 select-none">Dashboard Admin - Aktivitas Karyawan</h2>
    <div id="attendanceList" class="overflow-x-auto bg-white rounded-2xl shadow p-4 sm:p-6 max-h-[480px] scrollbar-thin scrollbar-thumb-rounded scrollbar-thumb-gray-400">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="border-b border-gray-300 text-gray-700 select-none">
            <th class="py-3 px-4">Nama Karyawan</th>
            <th class="py-3 px-4">Tanggal &amp; Waktu</th>
            <th class="py-3 px-4">Latitude</th>
            <th class="py-3 px-4">Longitude</th>
            <th class="py-3 px-4">Alamat</th>
            <th class="py-3 px-4">Keterangan</th>
          </tr>
        </thead>
        <tbody id="attendanceTableBody" class="divide-y divide-gray-200">
          <!-- Attendance rows inserted here dynamically -->
        </tbody>
      </table>
      <p id="noAttendanceMsg" class="text-center text-gray-500 mt-6 select-none hidden">Belum ada data aktivitas karyawan.</p>
    </div>
    <div class="flex justify-center mt-6">
      <button id="resetHistoryBtn" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
        Reset History Absensi
      </button>
    </div>
  </section>

  <!-- Reset Confirmation Modal -->
  <div id="resetConfirmModal" role="dialog" aria-modal="true" aria-labelledby="resetModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 hidden z-30">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8">
      <h3 id="resetModalTitle" class="text-2xl font-bold mb-6 text-center select-none">Konfirmasi Reset History</h3>
      <p class="text-gray-600 text-center mb-4 select-none">Masukkan PIN untuk menghapus semua data absensi karyawan:</p>
      <input type="password" id="resetPinInput" placeholder="Masukkan PIN (123)" class="mb-4 w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent" autocomplete="off" />
      <p id="resetErrorMsg" class="text-red-600 text-sm mt-2 hidden text-center select-none" role="alert"></p>
      <div class="flex justify-end space-x-4 mt-6">
        <button type="button" id="cancelResetBtn" class="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-gray-400">Batal</button>
        <button type="button" id="confirmResetBtn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-400">Konfirmasi</button>
      </div>
    </div>
  </div>


  <!-- Footer -->
  <footer class="text-center text-gray-400 text-sm py-6 mt-auto select-none">
    &copy; 2024 AbsenLokasi. All rights reserved.
  </footer>

<script type="module">
  // Firebase SDK Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Global Variables
  let db;
  let auth;
  let appId;
  let isFirebaseReady = false;
  let currentAttendanceRecordsWithIds = [];
  let isAdminLoggedIn = false; // Declared here as global

  (() => {
    // Admin hardcoded credentials
    const ADMIN_USERNAME = "admin";    // Changed back to 'admin'
    const ADMIN_PASSWORD = "password123"; // Changed back to 'password123'
    const RESET_PIN = "123";           // PIN for resetting history

    // Office coordinates
    const OFFICE_LAT = 3.5890625;
    const OFFICE_LON = 98.6679375;
    const ACCEPT_RADIUS_METERS = 200; // 200 meter radius

    // Elements
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminLoginModal = document.getElementById('adminLoginModal');
    const loginModalContent = document.getElementById('loginModalContent');
    const adminLoginForm = document.getElementById('adminLoginForm');
    const loginErrorMsg = document.getElementById('loginErrorMsg');

    const heroSection = document.getElementById('heroSection');
    const fiturSection = document.getElementById('fitur');
    const absenSection = document.getElementById('absen');
    const adminDashboard = document.getElementById('adminDashboard');
    const attendanceTableBody = document.getElementById('attendanceTableBody');
    const noAttendanceMsg = document.getElementById('noAttendanceMsg');

    const employeeNameInput = document.getElementById('employeeName');
    const detectBtn = document.getElementById('detectBtn');
    const locationCard = document.getElementById('locationCard');

    const resetHistoryBtn = document.getElementById('resetHistoryBtn');
    const resetConfirmModal = document.getElementById('resetConfirmModal');
    const resetPinInput = document.getElementById('resetPinInput');
    const resetErrorMsg = document.getElementById('resetErrorMsg');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    const cancelResetBtn = document.getElementById('cancelResetBtn');
    const firebaseLoadingOverlay = document.getElementById('firebaseLoadingOverlay');

    // --- Firebase Initialization and Authentication ---
    firebaseLoadingOverlay.classList.remove('hidden');

    const firebaseConfig = {
      apiKey: "AIzaSyA-2RDM1GU7IkwZ7FS7vNX-6Y4TxccKf0s",
      authDomain: "absensi-e120f.firebaseapp.com",
      projectId: "absensi-e120f",
      storageBucket: "absensi-e120f.firebasestorage.app",
      messagingSenderId: "691383791243",
      appId: "1:691383791243:web:456b6a7212c91165b4ae8e",
      measurementId: "G-Y4G72FMJJX"
    };

    appId = firebaseConfig.projectId;

    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        isFirebaseReady = true;
        firebaseLoadingOverlay.classList.add('hidden');
        updateUIForAdmin();
        setupFirestoreListener();
      } else {
        try {
          await signInAnonymously(auth);
        } catch (error) {
          console.error("Firebase Auth Error:", error);
          firebaseLoadingOverlay.classList.add('hidden');
          locationCard.innerHTML = `
            <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
              Gagal terhubung ke server absensi. Mohon periksa koneksi internet Anda atau hubungi admin jika masalah berlanjut. (${error.message})
            </div>
          `;
        }
      }
    });

    // --- Firestore Data Management ---
    function setupFirestoreListener() {
      if (!isFirebaseReady) return;

      const attendanceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendanceRecords');

      onSnapshot(attendanceColRef, (snapshot) => {
        const records = [];
        snapshot.forEach(doc => {
          records.push({ id: doc.id, ...doc.data() });
        });
        records.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        currentAttendanceRecordsWithIds = records;
        renderAttendanceTable();
      }, (error) => {
        console.error("Error fetching attendance records from Firestore:", error);
        locationCard.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
            Gagal memuat history absensi dari server: ${error.message}
          </div>
        `;
      });
    }

    async function saveAttendanceRecord(record) {
      if (!isFirebaseReady) {
        locationCard.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg p-4 mt-4 select-none">
            Aplikasi belum siap untuk menyimpan data. Silakan coba lagi.
          </div>
        `;
        return;
      }
      try {
        const attendanceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendanceRecords');
        await addDoc(attendanceColRef, {
          ...record,
          timestamp: Date.now()
        });
      } catch (e) {
        console.error("Error adding document to Firestore: ", e);
        locationCard.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
            Gagal menyimpan absensi ke server: ${e.message}
          </div>
        `;
      }
    }

    function renderAttendanceTable() {
      attendanceTableBody.innerHTML = '';
      if (currentAttendanceRecordsWithIds.length === 0) {
        noAttendanceMsg.classList.remove('hidden');
      } else {
        noAttendanceMsg.classList.add('hidden');
        for (const r of currentAttendanceRecordsWithIds) {
          const tr = document.createElement('tr');
          tr.classList.add('hover:bg-gray-50', 'transition');
          tr.innerHTML = `
            <td class="py-3 px-4 font-medium">${escapeHtml(r.name)}</td>
            <td class="py-3 px-4">${escapeHtml(r.datetime)}</td>
            <td class="py-3 px-4 font-mono">${escapeHtml(r.latitude)}</td>
            <td class="py-3 px-4 font-mono">${escapeHtml(r.longitude)}</td>
            <td class="py-3 px-4">${escapeHtml(r.address)}</td>
            <td class="py-3 px-4 font-semibold ${r.keterangan === 'Di luar lokasi' ? 'text-red-700' : 'text-green-700'} select-none">
              ${escapeHtml(r.keterangan)}
            </td>
          `;
          attendanceTableBody.appendChild(tr);
        }
      }
    }

    // Escape HTML for security (prevent XSS)
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    // Helper function to check if two dates are the same day
    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    // --- UI Logic and Event Listeners ---
    employeeNameInput.addEventListener('input', () => {
      detectBtn.disabled = employeeNameInput.value.trim().length === 0;
    });

    function formatDate(date) {
      const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
      return new Intl.DateTimeFormat('id-ID', options).format(date);
    }
    
    // Helper function to format time (e.g., 07:45)
    function formatTime(date) {
        const options = { hour: '2-digit', minute: '2-digit' };
        return new Intl.DateTimeFormat('id-ID', options).format(date);
    }

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Radius of the earth in meters
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const d = R * c; // Distance in meters
      return d;
    }
    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    // Login workflow
    adminLoginBtn.addEventListener('click', () => {
      loginErrorMsg.classList.add('hidden');
      adminLoginForm.reset();
      adminLoginModal.classList.remove('hidden'); // Show modal backdrop
      // Apply animation classes
      loginModalContent.classList.remove('opacity-0', 'scale-95');
      loginModalContent.classList.add('opacity-100', 'scale-100');
      adminLoginModal.focus();
    });

    document.getElementById('closeLoginModalBtn').addEventListener('click', () => {
      // Hide modal content with animation first
      loginModalContent.classList.remove('opacity-100', 'scale-100');
      loginModalContent.classList.add('opacity-0', 'scale-95');
      // Hide modal backdrop after animation
      loginModalContent.addEventListener('transitionend', function handler() {
        adminLoginModal.classList.add('hidden');
        loginModalContent.removeEventListener('transitionend', handler);
      }, {once: true}); // Use {once: true} to ensure handler only runs once
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && !adminLoginModal.classList.contains('hidden')) {
        document.getElementById('closeLoginModalBtn').click(); // Simulate click on close button
      }
    });

    adminLoginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = adminLoginForm.adminUsername.value.trim();
      const password = adminLoginForm.adminPassword.value;

      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        loginErrorMsg.classList.add('hidden');
        
        // Sembunyikan modal dengan animasi
        loginModalContent.classList.remove('opacity-100', 'scale-100');
        loginModalContent.classList.add('opacity-0', 'scale-95');

        // Setelah animasi selesai, sembunyikan backdrop dan update UI
        loginModalContent.addEventListener('transitionend', function handler() {
          adminLoginModal.classList.add('hidden');
          loginModalContent.removeEventListener('transitionend', handler);
          
          // Langsung panggil updateUIForAdmin tanpa pesan sementara di locationCard
          updateUIForAdmin(); 

        }, {once: true}); // Use {once: true} to ensure handler only runs once

      } else {
        loginErrorMsg.textContent = 'Username atau password salah.';
        loginErrorMsg.classList.remove('hidden');
      }
    });

    // Logout workflow
    adminLogoutBtn.addEventListener('click', () => {
      isAdminLoggedIn = false;
      updateUIForAdmin();
    });

    function updateUIForAdmin() {
      if (isAdminLoggedIn) {
        // Sembunyikan semua bagian pengguna biasa
        heroSection.classList.add('hidden');
        fiturSection.classList.add('hidden');
        absenSection.classList.add('hidden');
        adminLoginBtn.classList.add('hidden');

        // Tampilkan dashboard admin dan tombol logout
        adminDashboard.classList.remove('hidden');
        adminLogoutBtn.classList.remove('hidden');

        // Bersihkan input dan pesan sementara dari bagian pengguna (jika ada)
        locationCard.innerHTML = '';
        employeeNameInput.value = '';
        detectBtn.disabled = true;

        renderAttendanceTable(); // Render tabel dengan data Firestore
      } else {
        // Sembunyikan dashboard admin dan tombol logout
        adminDashboard.classList.add('hidden');
        adminLogoutBtn.classList.add('hidden');

        // Tampilkan semua bagian pengguna biasa
        heroSection.classList.remove('hidden');
        fiturSection.classList.remove('hidden');
        absenSection.classList.remove('hidden');
        adminLoginBtn.classList.remove('hidden');

        // Bersihkan input dan pesan sementara dari bagian admin (jika ada)
        locationCard.innerHTML = '';
      }
    }

    document.getElementById('startBtn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('absen').scrollIntoView({ behavior: 'smooth' });
    });

    detectBtn.addEventListener('click', () => {
      locationCard.innerHTML = `
        <div class="flex items-center justify-center space-x-2 mt-2">
          <svg class="w-5 h-5 animate-spin text-blue-600" fill="none" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="text-blue-600 font-medium">Mendeteksi lokasi...</span>
        </div>
      `;
      if (!navigator.geolocation) {
        locationCard.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
            Browser Anda tidak mendukung deteksi lokasi.
          </div>
        `;
        return;
      }
      const employeeName = employeeNameInput.value.trim();
      if (employeeName.length === 0) {
        locationCard.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg p-4 mt-4 select-none">
            Silakan masukkan nama karyawan terlebih dahulu.
          </div>
        `;
        return;
      }

      const today = new Date();
      // Check for duplicate attendance for the current employee on the current day
      const existingAttendanceToday = currentAttendanceRecordsWithIds.find(record =>
        record.name.toLowerCase() === employeeName.toLowerCase() &&
        record.timestamp && // Ensure timestamp exists
        isSameDay(new Date(record.timestamp), today)
      );

      if (existingAttendanceToday) {
        const recordedTime = formatTime(new Date(existingAttendanceToday.timestamp));
        locationCard.innerHTML = `
          <div class="bg-blue-50 border border-blue-200 text-blue-700 rounded-lg p-4 mt-4 select-none">
            Anda sudah absen hari ini pada pukul ${recordedTime}.
          </div>
        `;
        employeeNameInput.value = ''; // Clear the input field
        detectBtn.disabled = true; // Disable the button
        return; // Stop further execution
      }


      navigator.geolocation.getCurrentPosition(
        function(position) {
          const { latitude, longitude } = position.coords;
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`)
            .then(response => response.json())
            .then(data => {
              const address = data.display_name || "Alamat tidak ditemukan";
              const now = new Date();

              const distance = getDistanceFromLatLonInMeters(latitude, longitude, OFFICE_LAT, OFFICE_LON);
              const inLocation = distance <= ACCEPT_RADIUS_METERS;

              const keterangan = inLocation ? 'Di lokasi' : 'Di luar lokasi';

              let locationCardContent = '';
              if (inLocation) {
                locationCardContent = `
                  <div class="bg-green-50 border border-green-200 rounded-xl p-5 mt-4 flex flex-col items-center select-text">
                    <svg class="w-8 h-8 text-green-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                      <path d="M5 13l4 4L19 7" />
                    </svg>
                    <div class="text-green-700 font-semibold mb-1">Absensi berhasil dicatat!</div>
                    <div class="text-gray-700 text-sm">Nama: <span class="font-semibold">${escapeHtml(employeeName)}</span></div>
                    <div class="text-gray-700 text-sm">Waktu: <span class="font-mono">${formatDate(now)}</span></div>
                    <div class="text-gray-700 text-sm">Latitude: <span class="font-mono">${latitude.toFixed(6)}</span></div>
                    <div class="text-gray-700 text-sm">Longitude: <span class="font-mono">${longitude.toFixed(6)}</span></div>
                    <div class="text-gray-700 text-sm mt-2">Alamat: <span class="font-mono">${escapeHtml(address)}</span></div>
                    <div class="text-green-700 font-semibold mt-3 select-none">${keterangan}</div>
                  </div>
                `;
              } else {
                locationCardContent = `
                  <div class="urgent-alert border rounded-xl p-5 mt-4 flex flex-col items-center select-text">
                    <svg class="w-10 h-10 mb-3" fill="none" stroke="#b91c1c" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                      <path d="M12 9v2m0 4h.01M10.29 6.16a8 8 0 1113.42 10.69m-5.67-10.57L3 21" />
                    </svg>
                    <div class="text-red-700 text-xl font-extrabold mb-1">PERINGATAN DARURAT</div>
                    <div class="text-red-700 font-semibold mb-1">Karyawan tidak di lokasi kantor!</div>
                    <div class="text-gray-700 text-sm">Nama: <span class="font-semibold">${escapeHtml(employeeName)}</span></div>
                    <div class="text-gray-700 text-sm">Waktu: <span class="font-mono">${formatDate(now)}</span></div>
                    <div class="text-700 text-sm">Latitude: <span class="font-mono">${latitude.toFixed(6)}</span></div>
                    <div class="text-gray-700 text-sm">Longitude: <span class="font-mono">${longitude.toFixed(6)}</span></div>
                    <div class="text-gray-700 text-sm mt-2">Alamat: <span class="font-mono">${escapeHtml(address)}</span></div>
                    <div class="text-red-700 font-bold mt-3 select-none">${keterangan}</div>
                  </div>
                `;
              }
              locationCard.innerHTML = locationCardContent;

              const record = {
                name: employeeName,
                datetime: formatDate(now),
                latitude: latitude.toFixed(6),
                longitude: longitude.toFixed(6),
                address: address,
                keterangan: keterangan,
              };
              saveAttendanceRecord(record); // Save to Firestore

              employeeNameInput.value = '';
              detectBtn.disabled = true;
            })
            .catch(() => {
              locationCard.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg p-4 mt-4 select-none">
                  Lokasi terdeteksi, namun gagal mengambil nama alamat.
                  <div class="mt-2 text-sm">Latitude: <span class="font-mono">${latitude.toFixed(6)}</span>, Longitude: <span class="font-mono">${longitude.toFixed(6)}</span></div>
                </div>
              `;
            });
        },
        function(error) {
          let message = "Gagal mendeteksi lokasi.";
          if (error.code === 1) message = "Izin lokasi ditolak. Silakan izinkan akses lokasi pada browser Anda.";
          else if (error.code === 2) message = "Lokasi tidak tersedia.";
          else if (error.code === 3) message = "Permintaan lokasi melebihi waktu tunggu.";
          locationCard.innerHTML = `
            <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
              ${message}
            </div>
          `;
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    // Reset History functionality
    resetHistoryBtn.addEventListener('click', () => {
      resetPinInput.value = '';
      resetErrorMsg.classList.add('hidden');
      resetConfirmModal.classList.remove('hidden');
      resetPinInput.focus();
    });

    cancelResetBtn.addEventListener('click', () => {
      resetConfirmModal.classList.add('hidden');
    });

    confirmResetBtn.addEventListener('click', async () => {
      const enteredPin = resetPinInput.value;
      if (enteredPin === RESET_PIN) {
        if (!isFirebaseReady) {
          resetErrorMsg.textContent = 'Server tidak siap. Coba lagi.';
          resetErrorMsg.classList.remove('hidden');
          return;
        }
        try {
          const attendanceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendanceRecords');
          const q = query(attendanceColRef);
          const querySnapshot = await getDocs(q);

          const batch = writeBatch(db); // Use batch for efficient deletion
          querySnapshot.forEach((doc) => {
            batch.delete(doc.ref);
          });
          await batch.commit();

          console.log("All records deleted from Firestore!");
          resetConfirmModal.classList.add('hidden');
          locationCard.innerHTML = `
            <div class="bg-green-50 border border-green-200 text-green-700 rounded-lg p-4 mt-4 select-none">
              History absensi berhasil dihapus!
            </div>
          `;
          setTimeout(() => locationCard.innerHTML = '', 3000);
        } catch (e) {
          console.error("Error deleting documents: ", e);
          resetErrorMsg.textContent = `Gagal menghapus history: ${e.message}`;
          resetErrorMsg.classList.remove('hidden');
        }
      } else {
        resetErrorMsg.textContent = 'PIN salah. Silakan coba lagi.';
        resetErrorMsg.classList.remove('hidden');
      }
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && !resetConfirmModal.classList.contains('hidden')) {
        document.getElementById('closeLoginModalBtn').click();
      }
    });

    // Initial UI update will happen after Firebase authentication
    updateUIForAdmin();

  })();
</script>
</body>
</html>
